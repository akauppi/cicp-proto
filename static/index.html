<!DOCTYPE html>
<html lang="en">

<!-- /index.html
  Single page to test CICP (Firebase) authentication.

  Note: We aim at all pages needing auth, reachable by URLs. Thus, each page needs to sport the authentication setting
    (at least this is the start).

  Note: Latest Firebase versions can be seen at:
    - Firebase UI: https://github.com/firebase/firebaseui-web#installation

      Note: The CICP page uses version 5.8.2 (4-Aug-19) but there is no such version in the CDN (or the GitHub link).
          https://cloud.google.com/identity-platform/docs/quickstart-cicp
-->
<head>
  <title>CICP proto</title>
  <meta charset="utf-8">

  <!-- From https://cloud.google.com/identity-platform/docs/quickstart-cicp
  -->
  <script src="https://cdn.firebase.com/libs/firebaseui/4.1.0/firebaseui.js"></script>
  <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/4.1.0/firebaseui.css" />
</head>

<body>
<div id="logged-in" hidden="true">
  <h1>CICP proto</h1>

  <p>You are logged in as:</p>
  <div id="account-details"></div>

  <button id="log-out" style="padding: 20px; margin-top: 10px">Log out</button>
  <button id="forget" style="padding: 20px">Forget me!</button>    <!-- removes the id from the server -->
</div>

<div id="logged-out">
  <h1>CICP proto</h1>
  <p>Welcome. Please log in with the identity provider of your choice.</p>
  <div id="firebaseui-auth-container"></div>
</div>

<!-- Initialize the Firebase auth
-
- "Copy and paste these scripts into the bottom of your <body> tag, but before you use any Firebase services"
-   from https://console.firebase.google.com/u/0/project/cicp-proto-240219/settings/general/
-->
<script src="https://www.gstatic.com/firebasejs/6.3.4/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.3.4/firebase-auth.js"></script>

<script>
  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyC0xTjVyZZlqijHMVVlc9uWX-1XasEMr-A",
    authDomain: "cicp-proto-240219.firebaseapp.com",
    //databaseURL: "https://cicp-proto-240219.firebaseio.com",  // tbd. can we disable it
    projectId: "cicp-proto-240219",
    //storageBucket: "cicp-proto-240219.appspot.com",   // tbd. can we disable it
    //messagingSenderId: "541255637763",              // tbd. can we disable it
    //appId: "1:541255637763:web:0124c65a2249adae"
  };
  firebase.initializeApp(firebaseConfig);
</script>

<!-- Google CICP login widget -->
<script>
  // Firebase log-in widget
  //
  const ui = new firebaseui.auth.AuthUI( firebase.auth() );

  console.log("UI initialized");

  // "To use FirebaseUI to authenticate users you first need to configure each provider you want to use in their own
  // developer app settings."
  //    https://github.com/firebase/firebaseui-web#configuring-sign-in-providers

  /*** disabled
  // Based on https://firebase.google.com/docs/auth/web/google-signin#before_you_begin
  //
  const googleProvider = new firebase.auth.GoogleAuthProvider();
    //
    //googleProvider.addScope('profile');
    //googleProvider.addScope('email');
  ***/

  // Info on options -> https://github.com/firebase/firebaseui-web#configuration
  //
  const uiConfig = {
    signInSuccessUrl: '/',    // tbd. what should be here?

    signInOptions: [
      /* disabled
      // Using Google "one tap sign-in" ("beta closed", 5-Aug-2019)
      {
        provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
        authMethod: 'https://accounts.google.com',
        clientId: CLIENT_ID
      },*/
      firebase.auth.GoogleAuthProvider.PROVIDER_ID,

      // Don't have Facebook account.
      /* disabled
      {
        provider: firebase.auth.FacebookAuthProvider.PROVIDER_ID,
        scopes :[
          'public_profile',
          'email',
        ]
      },*/

      // Don't enable Twitter since it grants way too much rights (e.g. that we can tweet on behalf of the person)
      //firebase.auth.TwitterAuthProvider.PROVIDER_ID,

      firebase.auth.GithubAuthProvider.PROVIDER_ID,

      // Sign-in with email, without needing to give a password?
      //
      // From https://firebase.google.com/docs/auth/web/firebaseui#email_link_authentication
      //
      {
        provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
        signInMethod: firebase.auth.EmailAuthProvider.EMAIL_LINK_SIGN_IN_METHOD,
        forceSameDevice: false,
      }
    ],  // signInOptions

    tosUrl: '/404.html',      // "terms of service URL"

    callbacks: {
      signInSuccessWithAuthResult: function(authResult, redirectUrl) {
        // User successfully signed in.
        // Return type determines whether we continue the redirect automatically or whether we leave that to
        // developer to handle.
        return true;
      },

      // Called when the widget is rendered (can hide a "loading.." if we have any).
      uiShown: function() { }
    }

    /** disabled (one of these may be needed for the "one tap sign-in" but let's see when it's back available. Aug-19
    credentialHelper: //firebaseui.auth.CredentialHelper.GOOGLE_YOLO
          firebaseui.auth.CredentialHelper.ACCOUNT_CHOOSER_COM
     **/
  };

  // Don't call '.start' here.
  //
  // We do it if needed by the authentication (see below).   (very unsure about this!!!!)
  //
  // About 'ui.isPendingRedirect()':
  //  "The only reason for this API is to inform you that there is a pending redirect operation. Once you call [ui.]start(),
  //  the redirect is acted on."
  //  source: https://github.com/firebase/firebaseui-web/issues/478
</script>
<!-- end of Google CICP login widget -->

<script>
  const $loggedOut = document.querySelector("#logged-out");
  const $loggedIn = document.querySelector("#logged-in");

  /*
  * Call to initiate the login functionality
  */
  function configureFirebaseLogin() {
    /*
    * tbd. info here about '.onAuthStateChanged'
    */
    firebase.auth().onAuthStateChanged(function (user) {
      console.log("Auth state: ", user);

      // Is this the right way (and time/place) to decide, when logging UI initialization is needed?
      //
      if (!user || ui.isPendingRedirect()) {
        ui.start('#firebaseui-auth-container', uiConfig);   // ... WAIT
        console.log("Log-in UI started.");
      }

      if (user) {   // user logged in, no need to initialize the logging UI
        $loggedOut.hidden = true;

        // signed in
        var displayName = user.displayName;
        var email = user.email;
        var emailVerified = user.emailVerified;
        var photoURL = user.photoURL;
        var uid = user.uid;
        var phoneNumber = user.phoneNumber;
        var providerData = user.providerData;
        user.getIdToken().then( function(accessToken) {
          document.getElementById('account-details').textContent = JSON.stringify({
            displayName: displayName,
            email: email,
            emailVerified: emailVerified,
            phoneNumber: phoneNumber,
            photoURL: photoURL,
            uid: uid,
            accessToken: accessToken,
            providerData: providerData
          }, null, '  ');

          $loggedIn.hidden = false;
        });
      } else {
        // signed out
        $loggedIn.hidden = true;
        $loggedOut.hidden = false;
      }

    }, function(error) {
      console.log(error);
    });
  }
</script>
<!-- end of Google CICP -->

<script>
  window.addEventListener('load', () => {
    configureFirebaseLogin();
  });

  const $logout = document.querySelector("button#log-out");
  const $forgetMe = document.querySelector("button#forget");

  $logout.onclick = (ev) => {
    alert("British Bee!")

    firebase.auth().signOut().then( () => {
      console.log("Signed out")
    }).catch( () => {
      alert("Sign-out failed!")
    });
  };

  $forgetMe.onclick = (ev) => {
    alert("USB");
  }
</script>

</body>
